<?php

/**
 * Implementation of hook_menu() 
 */
function oneclick_client_menu() {
  
  $items['waiting'] = array(
    'page callback' => 'oneclick_client_is_waiting',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['create_sitecon/%'] = array(
    'page callback' => 'oneclick_client_create_sitecon_client',
    'page arguments' => array(1), 
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function oneclick_client_init() {
  //variable_set('site_waiting', TRUE); 
  //exit();
  if (!user_is_logged_in()) {

    if (variable_get('site_waiting', TRUE)) {
      variable_set('site_waiting', FALSE);
      variable_set('root_site', 'openweb.in.th');

      drupal_http_request('http://'.variable_get('root_site', '').'/create_sitecon/'.variable_get('site_name', 'localhost').'?return=true');
      $_GET['return'] = 'true';
      oneclick_client_create_sitecon_client(variable_get('root_site', ''));

      $resp = drupal_http_request('http://'.variable_get('root_site', '').'/get_user_from_client/'.variable_get('site_name', 'localhost').'?format=json');

      $roles = user_roles();
      unset($roles[0]);
      $user = (array) json_decode($resp->data);
      $uid = db_result(db_query("SELECT uid FROM {users} WHERE name = '%s'", array($user['name'])));
      if (empty($uid)) {
        $pass = $user['pass'];
        $user['roles'] = $roles;
        $user['status'] = 1;
        $user = user_save('', $user);
        db_query("UPDATE {users} SET pass = '%s' WHERE uid = %d", array($pass, $user->uid));
      }
      drupal_goto('http://'.variable_get('root_site', '').'/sitecon/client/connect/'.variable_get('site_name', 'localhost').'/login', 'redirect=http://'.variable_get('site_name', 'localhost'));
    } 
  }  
  
}

function oneclick_client_is_waiting() {
  print $_GET['callback'].'('.json_encode(array('waiting' => variable_get('site_waiting', TRUE))).')';
}

function oneclick_client_create_sitecon_client($id) {
  if (is_numeric($id)) {
    $site = sitecon_get_item($id, 'client');
  }
  else {
    $site = sitecon_get_item_from_domain($id, 'client');
  }

  if ($site){
    if ($_GET['return'] != 'true') {
      drupal_json(array('success' => TRUE));
    }
    if (isset($_GET['next'])) {
      drupal_goto($_GET['next']);
    }
  }
  else {
    if (is_numeric($id)) {
      $site = node_load($id);
      $domain = $site->title;
      $id = $site->nid;
    }
    else {
      $domain = $id;
      $id = 'NULL';
    }

    _create_sitecon($domain, $id);

    if ($_GET['return'] != 'true') {
      drupal_json(array('success' => TRUE));
    }
    if (isset($_GET['next'])) {
      drupal_goto($_GET['next']);
    }
  }
}

function oneclick_client_create_sitecon_server($id) {
}

function _create_sitecon($domain, $id = 'NULL') {
  $privatekey = rand(0, 9999999999);
  $apikey = _get_sitecon_apikey($domain, $privatekey);
  $sitecon = array(
    'id' => $id,
    'type' => 'client',
    'privatekey' => $privatekey,
    'domain' => $domain,
    'apikey' => $apikey,
    'op' => 'create',
  );
  _add_sitecon($sitecon);
}

function _add_sitecon($sitecon) {
  $type = $sitecon['type'];
  db_query("INSERT INTO sitecon_$type VALUES(%d, '%s', '%s', '%s') ON DUPLICATE KEY UPDATE apikey = '%s', privatekey = '%s'", array($sitecon['id'], md5($sitecon['privatekey']), $sitecon['domain'], $sitecon['apikey'], $sitecon['apikey'], md5($sitecon['privatekey'])));
}

function _get_sitecon_apikey($server_name, $privatekey) {
  $url = 'http://'.$server_name.'/sitecon/server/get_apikey/'.variable_get('site_name', 'localhost').'/'.md5($privatekey);
  $resp = drupal_http_request($url);
  if ($resp->code == 200) {
    return json_decode($resp->data);
  }
  return NULL;
}
